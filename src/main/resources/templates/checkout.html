<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('주문하기 - DDD Store')}"></head>
<body>
    <nav th:replace="~{fragments/layout :: nav}"></nav>

    <main class="py-5">
        <div class="container">
            <h2 class="mb-4"><i class="bi bi-credit-card"></i> 주문하기</h2>

            <div class="row">
                <!-- 주문 상품 정보 -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-box-seam"></i> 주문 상품</h5>
                        </div>
                        <div class="card-body">
                            <div id="orderItems">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 주문자 정보 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-person"></i> 주문자 정보</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">이름 *</label>
                                    <input type="text" class="form-control" id="ordererName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">전화번호 *</label>
                                    <input type="tel" class="form-control" id="ordererPhone" placeholder="010-1234-5678" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">이메일 *</label>
                                    <input type="email" class="form-control" id="ordererEmail" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 배송지 정보 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-truck"></i> 배송지 정보</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="sameAsOrderer" onchange="copySameAsOrderer()">
                                <label class="form-check-label" for="sameAsOrderer">
                                    주문자 정보와 동일
                                </label>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">수령인 *</label>
                                    <input type="text" class="form-control" id="receiverName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">연락처 *</label>
                                    <input type="tel" class="form-control" id="receiverPhone" placeholder="010-1234-5678" required>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">주소 *</label>
                                    <input type="text" class="form-control" id="address" placeholder="기본 주소" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">우편번호 *</label>
                                    <input type="number" class="form-control" id="zipCode" placeholder="12345" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">상세 주소</label>
                                    <input type="text" class="form-control" id="detailedAddress" placeholder="상세 주소">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 결제 방법 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-wallet2"></i> 결제 방법</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="paymentInfo" id="paymentCard" value="CARD" checked>
                                <label class="form-check-label" for="paymentCard">
                                    <i class="bi bi-credit-card"></i> 카드 결제
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentInfo" id="paymentCash" value="CASH">
                                <label class="form-check-label" for="paymentCash">
                                    <i class="bi bi-cash"></i> 현금 결제
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 배송 메시지 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-chat-text"></i> 배송 메시지</h5>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" id="message" rows="3" placeholder="배송 시 요청사항을 입력해주세요 (선택)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 주문 요약 -->
                <div class="col-lg-4">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-header">
                            <h5><i class="bi bi-receipt"></i> 주문 요약</h5>
                        </div>
                        <div class="card-body">
                            <!-- 쿠폰 선택 -->
                            <div class="mb-3">
                                <label class="form-label">쿠폰 선택</label>
                                <select class="form-select" id="couponSelect" onchange="calculateTotal()">
                                    <option value="">쿠폰을 선택하세요</option>
                                </select>
                                <small class="text-muted">사용 가능한 쿠폰이 로드됩니다</small>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between mb-2">
                                <span>상품 금액</span>
                                <span id="totalAmount">0원</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 text-danger">
                                <span>할인 금액</span>
                                <span id="discountAmount">-0원</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>결제 예정 금액</strong>
                                <strong class="text-primary fs-5" id="paymentAmount">0원</strong>
                            </div>
                            <button class="btn btn-primary w-100 btn-lg" onclick="placeOrder()">
                                <i class="bi bi-check-circle"></i> 결제하기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/layout :: footer}"></footer>
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        let cartItems = [];
        let availableCoupons = [];
        let totalPrice = 0;
        let memberId = null;
        let memberInfo = null;

        async function loadCheckoutData() {
            const token = getToken();
            if (!token) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
                return;
            }

            try {
                // 현재 로그인한 회원 정보 로드
                const memberResponse = await apiCall('/get-current-member');
                memberInfo = await memberResponse.json();
                memberId = memberInfo.memberId;

                // 회원 정보로 폼 미리 채우기
                document.getElementById('ordererName').value = memberInfo.name || '';
                document.getElementById('ordererEmail').value = memberInfo.email || '';

                // 장바구니 상품 로드
                const cartResponse = await apiCall('/carts');
                cartItems = await cartResponse.json();

                if (!cartItems || cartItems.length === 0) {
                    alert('장바구니가 비어있습니다.');
                    window.location.href = '/cart';
                    return;
                }

                renderOrderItems();
                calculateTotal();

                // 쿠폰 목록 로드
                const couponResponse = await apiCall(`/user-coupons/${memberId}`);
                availableCoupons = await couponResponse.json();
                renderCoupons();

            } catch (error) {
                console.error('주문 데이터 로드 실패:', error);
                alert('주문 데이터를 불러오는데 실패했습니다.');
            }
        }

        function renderOrderItems() {
            const container = document.getElementById('orderItems');
            totalPrice = 0;

            container.innerHTML = cartItems.map(item => {
                const itemPrice = item.price?.amount || 0;
                const itemTotal = itemPrice * item.quantity;
                totalPrice += itemTotal;

                return `
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <div>
                            <h6 class="mb-1">${item.productName || '상품'}</h6>
                            <small class="text-muted">${itemPrice.toLocaleString()}원 × ${item.quantity}개</small>
                        </div>
                        <strong>${itemTotal.toLocaleString()}원</strong>
                    </div>
                `;
            }).join('');
        }

        function renderCoupons() {
            const select = document.getElementById('couponSelect');
            const unusedCoupons = availableCoupons.filter(c => !c.isUsed);

            if (unusedCoupons.length === 0) {
                select.innerHTML = '<option value="">사용 가능한 쿠폰이 없습니다</option>';
                select.disabled = true;
                return;
            }

            select.innerHTML = '<option value="">쿠폰을 선택하세요</option>' +
                unusedCoupons.map(coupon => {
                    let discountText = '';
                    if (coupon.isRatio) {
                        discountText = `${(coupon.ratio * 100).toFixed(0)}% 할인`;
                    } else {
                        discountText = `${coupon.fixedAmount?.amount?.toLocaleString() || 0}원 할인`;
                    }
                    return `<option value="${coupon.id}"
                                    data-is-ratio="${coupon.isRatio}"
                                    data-ratio="${coupon.ratio || 0}"
                                    data-fixed-amount="${coupon.fixedAmount?.amount || 0}">
                            ${coupon.name} (${discountText})
                        </option>`;
                }).join('');
        }

        function calculateTotal() {
            const select = document.getElementById('couponSelect');
            const selectedOption = select.options[select.selectedIndex];

            let discount = 0;
            if (selectedOption && selectedOption.value) {
                const isRatio = selectedOption.dataset.isRatio === 'true';
                if (isRatio) {
                    const ratio = parseFloat(selectedOption.dataset.ratio);
                    discount = Math.floor(totalPrice * ratio);
                } else {
                    discount = parseInt(selectedOption.dataset.fixedAmount);
                }
            }

            const finalAmount = totalPrice - discount;

            document.getElementById('totalAmount').textContent = totalPrice.toLocaleString() + '원';
            document.getElementById('discountAmount').textContent = '-' + discount.toLocaleString() + '원';
            document.getElementById('paymentAmount').textContent = finalAmount.toLocaleString() + '원';
        }

        function copySameAsOrderer() {
            const checkbox = document.getElementById('sameAsOrderer');
            if (checkbox.checked) {
                // 주문자 정보
                document.getElementById('receiverName').value = document.getElementById('ordererName').value;
                document.getElementById('receiverPhone').value = document.getElementById('ordererPhone').value;

                // 회원 주소 정보
                if (memberInfo && memberInfo.address) {
                    document.getElementById('address').value = memberInfo.address.address || '';
                    document.getElementById('detailedAddress').value = memberInfo.address.detailedAddress || '';
                    document.getElementById('zipCode').value = memberInfo.address.zipCode || '';
                }
            } else {
                document.getElementById('receiverName').value = '';
                document.getElementById('receiverPhone').value = '';
                document.getElementById('address').value = '';
                document.getElementById('detailedAddress').value = '';
                document.getElementById('zipCode').value = '';
            }
        }

        async function placeOrder() {
            // 필수 입력값 검증
            const ordererName = document.getElementById('ordererName').value.trim();
            const ordererPhone = document.getElementById('ordererPhone').value.trim();
            const ordererEmail = document.getElementById('ordererEmail').value.trim();
            const receiverName = document.getElementById('receiverName').value.trim();
            const receiverPhone = document.getElementById('receiverPhone').value.trim();
            const address = document.getElementById('address').value.trim();
            const zipCode = document.getElementById('zipCode').value.trim();

            if (!ordererName || !ordererPhone || !ordererEmail) {
                alert('주문자 정보를 모두 입력해주세요.');
                return;
            }

            if (!receiverName || !receiverPhone || !address || !zipCode) {
                alert('배송지 정보를 모두 입력해주세요.');
                return;
            }

            // 주문 데이터 구성
            const orderLines = cartItems.map(item => ({
                productId: item.productId,
                price: item.price?.amount || 0,
                quantity: item.quantity
            }));

            const detailedAddress = document.getElementById('detailedAddress').value.trim() || '';

            const shippingInfo = {
                address: {
                    address: address,
                    detailedAddress: detailedAddress,
                    zipCode: parseInt(zipCode)
                },
                receiver: {
                    name: receiverName,
                    phoneNumber: receiverPhone
                }
            };

            const orderer = {
                memberId: memberId,
                name: ordererName,
                phoneNumber: ordererPhone,
                email: ordererEmail
            };

            const paymentInfo = document.querySelector('input[name="paymentInfo"]:checked').value;
            const message = document.getElementById('message').value.trim() || '';

            // 선택된 쿠폰 정보
            const couponSelect = document.getElementById('couponSelect');
            const coupons = [];
            if (couponSelect.value) {
                const selectedCoupon = availableCoupons.find(c => c.id === parseInt(couponSelect.value));
                if (selectedCoupon) {
                    coupons.push(selectedCoupon);
                }
            }

            const orderRequest = {
                orderLines,
                shippingInfo,
                message,
                orderer,
                paymentInfo,
                coupons
            };

            try {
                const response = await apiCall('/orders/place-order', {
                    method: 'POST',
                    body: JSON.stringify(orderRequest)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || '주문이 완료되었습니다.');

                    // 장바구니 비우기
                    await apiCall('/carts-all', { method: 'DELETE' });

                    // 주문 내역 페이지로 이동
                    window.location.href = '/my-orders';
                } else {
                    const errorText = await response.text();
                    alert('주문 실패: ' + errorText);
                }
            } catch (error) {
                console.error('주문 실패:', error);
                alert('주문 처리 중 오류가 발생했습니다.');
            }
        }

        document.addEventListener('DOMContentLoaded', loadCheckoutData);
    </script>
</body>
</html>
