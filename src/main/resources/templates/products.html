<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('상품 목록 - DDD Store')}"></head>
<body>
    <nav th:replace="~{fragments/layout :: nav}"></nav>

    <main class="py-5">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h2><i class="bi bi-grid"></i> 상품 목록</h2>
                    <p class="text-muted">다양한 상품을 둘러보세요</p>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="상품 검색...">
                        <button class="btn btn-outline-primary" type="button" onclick="searchProducts()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row g-4" id="productList">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">로딩중...</span>
                    </div>
                </div>
            </div>

            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
        </div>
    </main>

    <footer th:replace="~{fragments/layout :: footer}"></footer>
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        let currentPage = 0;
        const pageSize = 12;

        async function loadProducts(page = 0, search = '') {
            try {
                let url = `/products?page=${page}&size=${pageSize}`;
                if (search) {
                    url = `/products/search?title=${search}&page=${page}&size=${pageSize}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                // API가 Page 객체를 반환하는 경우와 List를 직접 반환하는 경우 모두 처리
                let products = [];
                let totalPages = 0;

                if (Array.isArray(data)) {
                    // List가 직접 반환되는 경우
                    products = data;
                    totalPages = Math.ceil(products.length / pageSize);
                } else if (data.content) {
                    // Page 객체가 반환되는 경우
                    products = data.content;
                    totalPages = data.totalPages || 0;
                }

                renderProducts(products);
                renderPagination(totalPages, page);
            } catch (error) {
                console.error('상품 로드 실패:', error);
                document.getElementById('productList').innerHTML =
                    '<div class="col-12 text-center text-danger">상품을 불러오는데 실패했습니다.</div>';
            }
        }

        function renderProducts(products) {
            const container = document.getElementById('productList');

            if (products.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5">등록된 상품이 없습니다.</div>';
                return;
            }

            container.innerHTML = products.map(product => `
                <div class="col-md-4 col-lg-3">
                    <div class="card h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${product.title || '제목 없음'}</h5>
                            <p class="card-text text-muted small flex-grow-1">
                                ${product.description || '상품 설명이 없습니다.'}
                            </p>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="h5 mb-0 text-primary">
                                        ${product.price ? product.price.toLocaleString() + '원' : '가격 정보 없음'}
                                    </span>
                                </div>
                                <div class="d-grid gap-2">
                                    <a href="/shop/${product.id}" class="btn btn-outline-primary btn-sm">
                                        상세보기
                                    </a>
                                    <button class="btn btn-primary btn-sm" onclick="addToCart(${product.id}, '${product.title}')">
                                        <i class="bi bi-cart-plus"></i> 장바구니
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPagination(totalPages, currentPage) {
            const paginationEl = document.getElementById('pagination');

            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 0; i < totalPages; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadProducts(${i}); return false;">${i + 1}</a>
                    </li>
                `;
            }

            paginationEl.innerHTML = html;
        }

        async function addToCart(productId, productTitle) {
            const token = getToken();
            if (!token) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
                return;
            }

            try {
                // 장바구니에 추가 (memberId는 서버에서 JWT로 자동 추출)
                const response = await apiCall('/carts', {
                    method: 'POST',
                    body: JSON.stringify({
                        productId: productId,
                        quantity: 1
                    })
                });

                if (response.ok) {
                    if (confirm(`${productTitle}을(를) 장바구니에 담았습니다.\n장바구니로 이동하시겠습니까?`)) {
                        window.location.href = '/cart';
                    }
                } else {
                    alert('장바구니 추가에 실패했습니다.');
                }
            } catch (error) {
                console.error('장바구니 추가 실패:', error);
                alert('장바구니 추가에 실패했습니다.');
            }
        }

        function searchProducts() {
            const search = document.getElementById('searchInput').value;
            currentPage = 0;
            loadProducts(currentPage, search);
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        document.addEventListener('DOMContentLoaded', () => loadProducts());
    </script>
</body>
</html>
