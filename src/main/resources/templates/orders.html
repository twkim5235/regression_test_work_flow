<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('주문내역 - DDD Store')}"></head>
<body>
    <nav th:replace="~{fragments/layout :: nav}"></nav>

    <main class="py-5">
        <div class="container">
            <h2 class="mb-4"><i class="bi bi-box-seam"></i> 주문내역</h2>

            <div id="orderList">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/layout :: footer}"></footer>
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        async function loadOrders() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await apiCall('/orders/my-order');
                const orders = await response.json();

                renderOrders(orders);
            } catch (error) {
                console.error('주문 로드 실패:', error);
                document.getElementById('orderList').innerHTML =
                    '<div class="text-center text-danger">주문 내역을 불러오는데 실패했습니다.</div>';
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('orderList');

            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5">주문 내역이 없습니다.</div>';
                return;
            }

            // 디버깅: 첫 번째 주문의 createdAt 확인
            if (orders.length > 0) {
                console.log('createdAt 원본 값:', orders[0].createdAt);
                console.log('createdAt 타입:', typeof orders[0].createdAt);
            }

            container.innerHTML = orders.map(order => {
                const statusClass = {
                    'PREPARING': 'warning',
                    'SHIPPED': 'info',
                    'DELIVERING': 'primary',
                    'DELIVERY_COMPLETED': 'success',
                    'CANCEL': 'danger'
                }[order.orderState] || 'secondary';

                // createdAt이 숫자(초)인 경우 밀리초로 변환, 문자열이면 그대로 사용
                let orderDate = '날짜 정보 없음';
                if (order.createdAt) {
                    const timestamp = typeof order.createdAt === 'number'
                        ? order.createdAt * 1000  // 초 → 밀리초 변환
                        : order.createdAt;
                    orderDate = new Date(timestamp).toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5>주문번호: ${order.orderId}</h5>
                                    <p class="text-muted mb-1">
                                        <i class="bi bi-calendar"></i>
                                        ${orderDate}
                                    </p>
                                    <p class="mb-1">
                                        <i class="bi bi-geo-alt"></i>
                                        ${order.shippingInfo ? order.shippingInfo.address.address : '주소 정보 없음'}
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-${statusClass} mb-2">${order.orderState}</span>
                                    <h4 class="text-primary mb-2">
                                        ${order.totalAmounts ? order.totalAmounts.amount.toLocaleString() + '원' : ''}
                                    </h4>
                                    ${order.orderState === 'PREPARING' ?
                                        `<button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.orderId})">
                                            주문취소
                                        </button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function cancelOrder(orderId) {
            if (!confirm('주문을 취소하시겠습니까?')) return;

            try {
                const response = await apiCall(`/orders?orderId=${orderId}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('주문이 취소되었습니다.');
                    loadOrders();
                }
            } catch (error) {
                console.error('주문 취소 실패:', error);
                alert('주문 취소에 실패했습니다.');
            }
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>
</html>
