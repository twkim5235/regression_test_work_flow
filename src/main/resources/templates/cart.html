<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('장바구니 - DDD Store')}"></head>
<body>
    <nav th:replace="~{fragments/layout :: nav}"></nav>

    <main class="py-5">
        <div class="container">
            <h2 class="mb-4"><i class="bi bi-cart"></i> 장바구니</h2>

            <div id="cartItems" class="row">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8 offset-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>주문 금액</h5>
                            <div class="d-flex justify-content-between mb-2">
                                <span>상품 금액</span>
                                <span id="totalAmount">0원</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>결제 예정 금액</strong>
                                <strong class="text-primary" id="paymentAmount">0원</strong>
                            </div>
                            <button class="btn btn-primary w-100" onclick="goToOrder()">
                                <i class="bi bi-credit-card"></i> 주문하기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/layout :: footer}"></footer>
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        async function loadCart() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await apiCall('/carts');
                const items = await response.json();

                renderCart(items);
            } catch (error) {
                console.error('장바구니 로드 실패:', error);
            }
        }

        function renderCart(items) {
            const container = document.getElementById('cartItems');

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5">장바구니가 비어있습니다.</div>';
                return;
            }

            let totalAmount = 0;

            container.innerHTML = items.map(item => {
                const itemPrice = item.price?.amount || 0;
                const itemTotal = itemPrice * item.quantity;
                totalAmount += itemTotal;

                return `
                    <div class="col-12 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h5>${item.productName || '상품'}</h5>
                                        <small class="text-muted">${itemPrice.toLocaleString()}원</small>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" value="${item.quantity}"
                                               min="1" onchange="updateQuantity(${item.id}, this.value)">
                                    </div>
                                    <div class="col-md-2">
                                        <strong>${itemTotal.toLocaleString()}원</strong>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-sm btn-danger" onclick="removeFromCart(${item.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + '원';
            document.getElementById('paymentAmount').textContent = totalAmount.toLocaleString() + '원';
        }

        async function removeFromCart(itemId) {
            if (!confirm('상품을 삭제하시겠습니까?')) return;

            try {
                await apiCall(`/carts?cartId=${itemId}`, { method: 'DELETE' });
                loadCart();
            } catch (error) {
                console.error('삭제 실패:', error);
            }
        }

        function goToOrder() {
            window.location.href = '/checkout';
        }

        document.addEventListener('DOMContentLoaded', loadCart);
    </script>
</body>
</html>
